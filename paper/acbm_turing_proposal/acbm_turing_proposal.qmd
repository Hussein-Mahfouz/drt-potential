---
title: "Building an Activity-Base Model"
date: "`r format(Sys.time(), '%d %m %y')`"
format:
  #gfm: default
  # html:
  #   toc: true
  docx:
    toc: true
    toc-depth: 2
    number-sections: true
  # pdf:
  #   toc: true
  #   number-sections: true
  #   extra_dependencies: ["float"]
keep-tex: true
bibliography: ../lit-review.bib
# elsevier style for referencing (from https://github.com/citation-style-language/styles)
csl: ../elsevier-harvard.csl
---

# Background

## Limitations of traditional demand models

In multimodal transport planning, 4-step models have been the default for decades. However these models have theoretical and technical limitations [@rasouli2014activity]:

-   they lack of integrity (consistency between sub-models). This means that they lack behavioral realism; allocation of individuals to destinations that are infeasible in reality as they do not match their time budget.

-   they do not capture the dependence of trips in a trip chain, or between members of the same household (e.g. school drop-off). This means that only direct policy effects are studied; the effect of changes in a persons travel on other members of the household are not addressed.

-   they are very aggregate models in both time and space. Demand is aggregated into peak and off-peak periods, and all trips flow between area centroids. Among the many issues with this aggregation is the inability to model dynamic modes such as demand-responsive transport or to look at equity implications of different scenarios

Activity-based models promise to address many of these limitations

## What is an Activity-Based Model (AcBM)?

Activity-based models are grounded in the idea that travel demand is an outcome of the necessity to participate in activities. They aim to capture the sequence of activities that individuals participate in, when and for how they participate in these activities, what modes they use, household (or social network) interactions, while accounting for spatial, temporal, budget constraints among others [@rasouli2014activity]. In comparison to 4-step models, they have finer spatial and temporal resolution, and maintain integrity through trip chaining, household interactions, and constraints.

Besides model integrity, there are many benefits to this disaggregate modeling approach, including the ability to model dynamic modes such as demand-responsive transport and to look at equity implications of different scenarios. (CITE!).

## Types of AcBM

There are a number of approaches for generating AcBMs. @rasouli2014activity group the modeling approaches under 3 different categories:

-   **Constraint-based models**: These do not generate activity schedules but check whether an activity chain is feasible given space-time constraints
-   **Utility-maximizing models:** These are discrete choice models based on premise that individuals try to maximise utility when deciding between a set of activity-travel patterns. The CEMDEP model [@bhat2004comprehensive] is one of the most popular models in this category. Notable issues with these models is that they fail to capture imperfect behaviour and use homgeneous utility functions which don't capture the variation in preferences between individuals \[@sallard2023travel\].
    -   grounded in discrete choice modeling, and mainly use the nested logit.

<!--# 3 modeling approaches: [1] daily activity schedule model: nested logit model  ……. [2] Prism-Constrained activity travel simulator: accounts for prism (space-time) constraints and availability of travel modes  nested logit for activity type choice. Another one for destination and transport mode -->

-   **Computational process (or rule-based) models:** these use decision heuristics that mimic underlying decision-making process. This means including preferences as well as prior commitments and constraints. Examples include ALBATROSS [@arentze2004learning] which uses complex decision trees, and TASHA [@miller2003prototype] which relies on empirical distributions.

The reality has become slightly more complex, and the pipeline of building an activity-based model can involve combinations of these methods (e.g. utility-based models with spacetime prism constraints). Below we go over the different steps involved in building an AcBM, and the different methods used for each one.

# Building an AcBM

AcBMs normally rely on a synthetic population to which activities are then added.

## Step 1: **Generate synthetic population**

Synthetic populations are composed of agents that have characteristics resembling real people, with the distribution of characteristics matching that of the real population. A number of methods exist to create synthetic populations, including synthetic reconstruction, combinatorial optimisation, and statistical learning (see [@fig-synth_pop_methods])

![Popular methods for synthetic population generation [@fabrice2021comparing]](images/synthetic_pop_methods_diagram.png){#fig-synth_pop_methods}

Synthetic populations already exist through the Synthetic Population Estimation and Scenario Projection (SPENSER) tool [@lomax2022open]. The opensource package humanleague [@smith2018humanleague] allows for the creation of synthetic populations using Iterative Propotional Fitting (IPF), Quasirandom Integer Sampling (QIS) and Quasirandom Integer Sampling of IPF (QISI). The synthetic population catalyst [@salat2023synthetic] built on SPENSER to create synthetic populations for all lieutenancy areas in England.

### Population projection for future years

A number of different population projection methods are referred to in @predhumeau2023synthetic :

-   *Static projection [@lomax2022open] :* Reconstruction methods like IPF are applied to a base synthetic population to make it fit projected marginals[^1]

-   *Dynamic projection [@fatmi2017baseline; @bae2016combining]*: Ageing the population, adding and removing individuals through births, deaths, and migration

-   *Resampling*: using the base population, and duplicating or removing individuals to fit the projected marginals

[^1]: projected marginals are estimated future values of demographic variables (e.g. age, sex, race) for specific subgroups of the population.

![](images/synthetic_pop.png)

## Step 2: **Add activity patterns to population**

The second step is to attach an activity schedule to each individual in the synthetic population. This step requires a household travel survey (or time use dataset) for a sample of the population. Each individual from the synthetic population is matched onto a profile from the household travel survey. Methods for matching include:

### Statistical Matching

1.  Statistical matching [@d2006statistical; @namazi2017unconstrained; @manon2023drt]. These methods use households travel surveys and sociodemographic attributes to attach activity chains to individuals. The method consists of matching each synthetic agent to an activity schedule from the survey based on socio-demographic and socio-economic attributes. The activity schedule in the surveys include mode of travel, and so the mode choice of synthetic agents is derived from the statistical matching approach.

### Data-driven methods

1.  Sequence alignment [@shoval2007sequence]: This method is used to check if synthesised daily plans are good representations of reality

    <!--# "To include the sequential dependencies of daily activities, some studies have suggested the use of Sequence Alignment Methods (SAMs) (Joh and Timmermans, 2011 https://doi.org/10.3141/2231-02; Joh et al., 2002 https://doi.org/10.1016/S0191-2615(01)00009-1; Wilson, 1998 https://doi.org/10.1068/a301017)," -->

2.  profile Hidden Markov Models (pHMM) [@saadi2016forecasting]

3.  Bayesian networks

    1.  [@joubert2020activity]: The approach only models activity sequences and mode choice, and is extended in @de2022explainable to model time spent at each activity. It could be used to predict mode of travel given activity sequence.

    2.   [@sallard2023travel]: They compare Bayesian Networks with statistical matching and find comparable performance in generating activity chains. Unlike @joubert2020activity and @de2022explainable, the approach does not consider mode choice.

## Step 3: **Assign activities to geographic locations** 

Many approaches in the literature focus on matching individuals to activity schedules, but do not proceed to imposing the generated schedules onto geographic space. This step is essential for agent-based transport simulations such as MATSim.

### Primary locations 

Methods exist for assigning agents to residential and primary locations. Residential location models are mainly based on discrete choice [@schirmer2014role], but can also use microsynthesis[^2] [@lomax2022open]. The choice of primary locations such as work and school is modeled using gravity [@sa2004determinants] or radiation models [@simini2012universal; @yang2014limits] . A comparison of both can be found in @masucci2013gravity. @vitins2016integration introduce a utility-maximising model with capacity constraints added through the use of shadow prices.

[^2]: I am not sure about this statement. Does [@lomax2022open] assign individuals to home locations (household level not area-level)?

### Secondary locations 

On their own, the approaches for primary location assignment cannot be used to model an entire trip chain which includes secondary locations[^3] (e.g. grocery shopping) [@horl2023relaxation].

[^3]: Sometimes also described as discretionary locations.

The most common approaches for filling in gaps between primary locations are based on *space-time prisms*. This involves 2 steps:

1.  Generating feasible secondary locations that can be reached within the time budget of the individual (time budgets are determined from their assigned activity schedules). Travel time matrices are needed to determine feasible destinations.

2.  Choosing a destination from the feasible set. Methods include choice models [@yoon2012feasibility; @justen2013use] and more recently, bayesian networks [@ma2018bayesian]. @horl2023relaxation propose an alternative algorithm that assigns secondary locations by attempting to reproduce the distance distributions in the data. It does not attempt to model the underlying choice process, and they emphasise that it is a location assignment model, not a location choice model. The main benefits are the minimal data requirements (activity chains, reference distance distributions, and activity locations) and that a choice model does not need to be estimated. The model is meant to give preliminary results which can later be refined in an agent-based simulation.

Another less common approach is based on optimization. It involves solving the Traveling Salesman Problem with Time Windows (TSP-TW) [@esztergar2018extensions; @esztergar2020trip]

A third approach involves creating activity patterns from mobile phone data without the need for travel surveys. The data can either be disaggregated [@jiang2016timegeo; @lin2017deep] or aggregated [@anda2021synthesising]. Aggregated, privacy-preserving methods are an important development in facilitating the use of user trajectory data. However, the proprietary nature of mobile phone data can be a barrier to adopting methods that are based on it.

Research on next location prediction could also be used to identify discretionary location choice. This work requires mobile phone data, and methods include neural networks [@hong2023context] and large language models [@wang2023would].

![](images/acbm_activity_synthesis.png)

## Mode Choice

Mode choice can either be done in Step 2, or in step 3.

**Step 2**

In statistical matching approaches @manon2023drt, the activity schedule in the surveys include mode of travel, and so the mode choice of synthetic agents is derived from the statistical matching approach.

@ma2017causal use bayesian networks to predict mode choice using socio-demographic, spatial, and journey characteristic variables. The work focuses on commuting trips but can be extended to look at entire activity chains, while adding constraints to maintain model integrity. @joubert2020activity use bayesian networks to predict mode choice throughout the activity chain, with modes being predicted sequentially for each trip chain, and posterior probabilities being updated as you move to the next trip. The approach only models activity sequences and mode choice, but not time spent at each activity. @de2022explainable extend the model to include activity durations.

**Step 3**

Discrete choice models that combine residential location, car ownership, activity schedules, and mode choice.[^4] @pinjari2011modeling use commuting trips, while @ben1998integration use entire activity schedules

[^4]: I have not looked at this properly and I don't yet understand how it fits into the pipeline

<!--# Step 4: Validation -->

<!--# https://www.sciencedirect.com/science/article/pii/S0957417415001657 -->

## Data Inputs

### Synthetic population 

-   Socio-demographic data (census)

-   Health surveys

### Activity-based model

**Activity generation and scheduling**

-   Household travel survey

    -   NTS

    -   Time Use Survey

**Feasible locations**

-   Activity locations: these can be queried from OSM. The ONS has a [POI dataset](https://www.ordnancesurvey.co.uk/products/points-of-interest) for Britain. Arup also have a package ([osmox](https://github.com/arup-group/osmox/tree/main)) for this exact purpose

**Location choice**

-   Commuting matrices

    -   census

-   GTFS feeds, which we use to get travel time matrices by mode at different times of day

![](images/input_data.png)

## Software / Code

### Synthetic population

**Population projections**

-   https://github.com/nismod/ukpopulation

-   https://github.com/nismod/microsimulation (check this one again)

**Synthetic reconstruction (Microsimulation)**

-   [humanleague package](https://github.com/virgesmith/humanleague)

**Scenario Modeling**

-   https://github.com/nismod/simim

**Spatial distribution at sub-zone level**

-   https://github.com/geospatialncl/OpenUDM

### Activity-based modeling

**Entire pipeline**

-   [ActivitySim](https://activitysim.github.io/activitysim/v1.2.0/index.html#)

**Location choice**

-   sampling locations while accounting for journey time constraints: [pam code](https://github.com/arup-group/pam/blob/main/examples/10_advanced_spatial_sampling.ipynb)

-   [code on discretionary locations](https://github.com/arup-group/pam/blob/main/examples/17_advanced_discretionary_locations.ipynb)

# Open Research Areas

The shift from traditional 4-step models to activity-based transport models opens up many exciting research areas. Developing tools and pipelines for generating activity based models can allow us to:

-   predict activity patterns along a longer time horizon [@beige2008long; @beige2012interdependencies]

    -   Needs change dynamically in response to weather, seasons, specific events etc

        -   build up of stress over time can lead to breaking travel habits

-   use activity patterns to measure quality of life by looking at amount of discretionary time (and what activities are done in it?)

-   Use activity as input into agent-based simulations

    -   include route choice as part of the larger choice problem. Currently route choice / assignment still comes after demand generation, and this violates integrity of the models -\> THIS IS WHAT MATSIM DOES

    -   Models that account for attitudes, nonlinear perception, learning, bounded rationality etc)

-   Model the effects of group decision making (family) and incorporate social networks into our models

-   Study how the transport and land-use facilitate dynamic plans [@auld2012activity]: if we have a model pipelines that generates dynamic plans (i.e. spontaneous decision to go to the shop after going for dinner), we can simulate scenarios with spontaneity and see how the transport supply accommodates it. These scenarios would more closely resemble the actual process of activity scheduling.

-   Look at feedback loop between network design and activity plans. This includes both the road network [@kang2013activity] and the public transport network. Demand is elastic, and is a function of infrastructure and the transport network.

    -   Research could involve agent-based simulations

-   Personalised incentives for sustainable mobility [@xiong2020integrated]

    -   Stage 1: For each travel behavior that might be specified (incentivized), identify the best compensation scheme to offer the agent.

    -   Stage 2: For each agent, determine the best choice of behavior to incentivize via a system-level optimization approach based on
        Stage 1 incentives.

\pagebreak

# References
